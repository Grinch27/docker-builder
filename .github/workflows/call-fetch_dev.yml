name: Fetch (Dev)

run-name: Fetch Matrix for Docker

on:
  repository_dispatch:
  workflow_dispatch:

jobs:
  fetch-layers:
    name: ${{ matrix.image_name }} - ${{ matrix.os }}/${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        image_name: ["alpine:latest", "debian:latest", "ubuntu:latest"]
        os: ["linux"]
        arch: ["amd64", "arm64"]
    outputs:
      layers: ${{ steps.meta_image.outputs.layers }}
    steps:
      - name: Setup environment
        run: |
          sudo apt-get -qq update
          sudo apt-get -qq install -y ca-certificates curl gpg skopeo jq

      - name: Get Docker MetaData from DockerHub
        id: meta_image
        run: |
          repo="${{ matrix.image_name }}"
          platform="${{ matrix.os }}/${{ matrix.arch }}"
          echo "Inspecting image: $repo for platform: $platform"

          os="${{ matrix.os }}"
          arch="${{ matrix.arch }}"
          variant=""
          if echo "${arch}" | grep -q "arm/v"; then
            variant=$(echo "${arch}" | cut -d'/' -f2)
            arch=$(echo "${arch}" | cut -d'/' -f1)
          fi

          data_json=$(skopeo inspect \
            --override-os="${os}" \
            --override-arch="${arch}" \
            ${variant:+--override-variant="${variant}"} \
            --format=json \
            docker://docker.io/"${repo}" | jq .)

          echo "MetaData for $repo on $platform:"
          echo "${data_json}" | jq .

          # 提取镜像层信息，假定在 .Layers 属性中（返回 JSON 数组字符串）
          layers=$(echo "${data_json}" | jq -c '.Layers')
          echo "Layers: $layers"

          # 将 layers 作为输出传递下游作业（确保输出为单行 JSON 字符串）
          echo "layers=$layers" | tee -a ${GITHUB_OUTPUT}

      - name: Display Docker Layers in Log
        if: ${{ 'true' == 'false' }} # disable
        run: |
          # 从输出中获取 layers（原始值为嵌套 JSON 字符串）
          layers="${{ steps.meta_image.outputs.layers }}"
          echo "Docker layers for image ${{ matrix.image_name }} on platform ${{ matrix.os }}/${{ matrix.arch }}:"
          # 使用 -R -s 将原始输入作为字符串读入，再用 fromjson 解析为 JSON 数组，逐行输出每一层
          echo "$layers" | jq -R -s 'fromjson | .[]'

  show-all-layers:
    name: Show Aggregated Layers from All Matrix Jobs
    runs-on: ubuntu-latest
    needs: fetch-layers
    steps:
      - name: Aggregated Output
        run: |
          echo "Aggregated Docker Layers outputs (JSON map):"
          echo "${{ toJSON(needs.fetch-layers.outputs) }}"
