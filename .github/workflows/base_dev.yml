name: Base Image Info (Dev)

on:
  push:
    paths:
      - ".github/workflows/base_dev.yml"
  pull_request:
    paths:
      - ".github/workflows/base_dev.yml"
  repository_dispatch:
  workflow_dispatch:

run-name: Base Image Info

jobs:
  base:
    name: ${{ matrix.image_name }} - ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        image_name: ["alpine:latest", "debian:latest", "ubuntu:latest"]
        os: ["linux"]
        arch: ["amd64", "arm64"]
    outputs:
      result: ${{ steps.output.outputs.result }}
    steps:
      - name: Setup and Fetch Layer Info
        id: output
        run: |
          sudo apt-get -qq update
          sudo apt-get -qq install -y ca-certificates curl gpg skopeo jq

          repo="${{ matrix.image_name }}"
          os="${{ matrix.os }}"
          arch="${{ matrix.arch }}"
          echo "Inspecting image: $repo for platform: $os/$arch"

          data_json=$(skopeo inspect \
            --override-os="${os}" \
            --override-arch="${arch}" \
            --format=json \
            docker://docker.io/"${repo}")

          # ç›´æŽ¥åˆ›å»ºç»“æžœå¹¶è¾“å‡º
          result=$(echo "$data_json" | jq -c --arg image "$repo" --arg arch "$arch" --arg os "$os" '{
            image: $image,
            architecture: $arch,
            os: $os,
            layers: .Layers,
            layer_count: (.Layers | length)
          }')

          echo "result=$result" >> $GITHUB_OUTPUT
          echo "âœ… Processed $repo ($arch): $(echo "$result" | jq -r '.layer_count') layers"

  show-all-layers:
    name: Show Aggregated Results
    runs-on: ubuntu-latest
    needs: base
    steps:
      - name: Collect and Display Results
        run: |
          echo "=== Docker Base Images Layer Information ==="
          echo

          # æ”¶é›†æ‰€æœ‰çŸ©é˜µä½œä¸šçš„è¾“å‡º
          all_outputs='${{ toJSON(needs.base.outputs) }}'
          
          # å°†æ‰€æœ‰è¾“å‡ºç»„åˆæˆæ•°ç»„
          results=$(echo "$all_outputs" | jq '[.result] | map(select(. != null and . != ""))')
          
          echo "=== Individual Image Analysis ==="
          echo

          # å¤„ç†æ¯ä¸ªç»“æžœ
          echo "$results" | jq -r '.[]' | while read -r result; do
            if [ -n "$result" ]; then
              image=$(echo "$result" | jq -r '.image')
              arch=$(echo "$result" | jq -r '.architecture') 
              count=$(echo "$result" | jq -r '.layer_count')
              
              echo "ðŸ“¦ Image: $image ($arch)"
              echo "   Layers: $count"
              echo "   Layer hashes:"
              echo "$result" | jq -r '.layers[]' | sed 's/^/     - /'
              echo
            fi
          done

          echo "=== Summary Report ==="
          echo

          # ç”Ÿæˆç»Ÿè®¡æŠ¥å‘Š
          summary=$(echo "$results" | jq '{
            total_images: length,
            images_by_arch: (group_by(.architecture) | map({(.[]|.architecture): length}) | add),
            layer_stats: (map(.layer_count) | {min: min, max: max, avg: (add/length)})
          }')

          echo "ðŸ“Š Statistics:"
          echo "$summary" | jq -r '
            "Total images analyzed: \(.total_images)",
            "Images by architecture:",
            (.images_by_arch | to_entries | map("  - \(.key): \(.value) images") | join("\n")),
            "Layer count statistics:",
            "  - Min layers: \(.layer_stats.min)",
            "  - Max layers: \(.layer_stats.max)",
            "  - Avg layers: \(.layer_stats.avg | floor)"
          '
          fi

  show-all-layers:
    name: Show Aggregated Layers from All Matrix Jobs
    runs-on: ubuntu-latest
    needs: base
    steps:
      - name: Aggregated Output
        run: |
          echo "=== Docker Base Images Layer Information ==="
          echo

          # æ”¶é›†æ‰€æœ‰è¾“å‡º - çŽ°åœ¨æ˜¯ä¸€ä¸ªç®€å•çš„æ•°ç»„
          all_results='${{ toJSON(needs.base.outputs.results) }}'
          echo "Raw results from matrix jobs:"
          echo "$all_results"
          echo

          echo "=== Individual Image Analysis ==="
          echo

          # å¤„ç†ç»“æžœæ•°ç»„
          echo "$all_results" | jq -r '.[]' | while read -r layer_info; do
            if [ -n "$layer_info" ] && [ "$layer_info" != "null" ] && [ "$layer_info" != "{}" ]; then
              echo "Processing layer info..."
              
              # è§£æž JSON
              if parsed_info=$(echo "$layer_info" | jq . 2>/dev/null); then
                image_name=$(echo "$parsed_info" | jq -r '.image // "unknown"')
                arch=$(echo "$parsed_info" | jq -r '.architecture // "unknown"')
                layer_count=$(echo "$parsed_info" | jq -r '.layer_count // 0')
                
                echo "ðŸ“¦ Image: $image_name ($arch)"
                echo "   Layers: $layer_count"
                echo "   Layer hashes:"
                echo "$parsed_info" | jq -r '.layers[]? // empty' | sed 's/^/     - /'
                echo
              else
                echo "âŒ Failed to parse layer info"
                echo "   Raw value: $layer_info"
                echo
              fi
            fi
          done

      - name: Generate Summary Report
        run: |
          echo "=== Summary Report ==="
          echo

          all_results='${{ toJSON(needs.base.outputs.results) }}'

          # åˆ›å»ºæ±‡æ€»ç»Ÿè®¡
          summary=$(echo "$all_results" | jq '
            map(select(. != null and . != {} and .image != null)) as $valid_data |
            if ($valid_data | length) > 0 then
              {
                total_images: ($valid_data | length),
                images_by_arch: (
                  $valid_data | 
                  group_by(.architecture // "unknown") | 
                  map({
                    arch: (.[0].architecture // "unknown"), 
                    count: length
                  }) |
                  reduce .[] as $item ({}; .[$item.arch] = $item.count)
                ),
                layer_stats: (
                  $valid_data | 
                  map(.layer_count // 0) | 
                  {min: min, max: max, avg: (add / length)}
                )
              }
            else
              {
                total_images: 0,
                images_by_arch: {},
                layer_stats: {min: 0, max: 0, avg: 0}
              }
            end
          ')

          echo "ðŸ“Š Statistics:"
          if [ "$(echo "$summary" | jq -r '.total_images')" -gt 0 ]; then
            echo "$summary" | jq -r '
              "Total images analyzed: \(.total_images)",
              "Images by architecture:",
              (.images_by_arch | to_entries | map("  - \(.key): \(.value) images") | join("\n")),
              "Layer count statistics:",
              "  - Min layers: \(.layer_stats.min)",
              "  - Max layers: \(.layer_stats.max)", 
              "  - Avg layers: \(.layer_stats.avg | floor)"
            '
          else
            echo "No valid image data was collected."
            echo "Debug: All results:"
            echo "$all_results"
          fi
              "Layer count statistics:",
              (if .layer_stats.min != null then
                "  - Min layers: \(.layer_stats.min)",
                "  - Max layers: \(.layer_stats.max)", 
                "  - Avg layers: \(.layer_stats.avg | floor)"
              else
                "  - No layer statistics available"
              end)
            '
          else
            echo "No valid image data was collected."
            echo "Debug: All outputs structure:"
            echo "$all_outputs" | jq .
          fi
